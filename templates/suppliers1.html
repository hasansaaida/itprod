{% extends 'base.html' %}
{% block content %}
<div dir="rtl" style="text-align:right">
  <h3 class="mb-3">ניהול ספקים</h3>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
  
  <div class="card mb-3">
    <div class="card-header fw-bold">הוספת ספק</div>
    <div class="card-body">
      <form id="f-supplier" class="row g-2">
        <div class="col-md-4">
          <label class="form-label">שם ספק</label>
          <input name="name" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">איש קשר</label>
          <input name="contact_person" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">טלפון</label>
          <input name="phone" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">אימייל</label>
          <input name="email" type="email" class="form-control">
        </div>
        <div class="col-12 text-start">
          <button class="btn btn-primary">הוסף ספק</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header fw-bold">טבלת ספקים</div>
    <div class="card-body">
      <table id="tbl-suppliers" class="table table-striped table-bordered w-100"></table>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
const he = {
  sProcessing:"מעבד...",
  sLengthMenu:"הצג _MENU_",
  sZeroRecords:"לא נמצאו רשומות",
  sInfo:"_START_–_END_ מתוך _TOTAL_",
  sInfoEmpty:"0 מתוך 0",
  sInfoFiltered:"(מסונן מ-_MAX_)",
  sSearch:"חיפוש:",
  oPaginate:{ sFirst:"ראשון", sPrevious:"קודם", sNext:"הבא", sLast:"אחרון" }
};

const dtSuppliers = $('#tbl-suppliers').DataTable({
  ajax: '/system/api/suppliers',
  language: he,
  columns: [
    {title:'ID', data:'id', width:'60px'},
    {title:'שם ספק', data:'name'},
    {title:'איש קשר', data:'contact_person'},
    {title:'טלפון', data:'phone'},
    {title:'אימייל', data:'email'},
    {title:'נוצר ב-', data:'created_at', width:'140px'},
    {title:'פעולות', data:null, orderable:false, width:'160px',
      render: r => `<button class="btn btn-sm btn-outline-primary me-1" onclick="editSupplier(${r.id})">ערוך</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="delSupplier(${r.id})">מחק</button>` }
  ]
});

$('#f-supplier').on('submit', async (e) => {
  e.preventDefault();
  const body = Object.fromEntries(new FormData(e.target).entries());
  const r = await fetch('/system/api/suppliers', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  if(r.ok){
    e.target.reset();
    dtSuppliers.ajax.reload(null,false);
  } else alert('שמירת ספק נכשלה');
});

window.delSupplier = async (id)=>{
  if(!confirm('למחוק ספק?')) return;
  const r=await fetch(`/system/api/suppliers/${id}`,{method:'DELETE'});
  if(r.ok) dtSuppliers.ajax.reload(null,false);
  else alert('מחיקה נכשלה');
};

window.editSupplier = (id)=>alert('עריכת ספק #' + id);
</script>
{% endblock %}
